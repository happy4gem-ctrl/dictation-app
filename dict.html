<!DOCTYPE html>
<html lang="zh-HK">
<head>

    <meta charset="UTF-8">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KSRHNQN475"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KSRHNQN475');
    </script>
    
    <title>é»˜æ›¸å°åŠ©æ‰‹...</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é»˜æ›¸å°åŠ©æ‰‹">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    
    <title>é»˜æ›¸å°åŠ©æ‰‹ (é›™èªæ¨™é»ç‰ˆ) ğŸŒ</title>
    <style>
        :root { --primary: #2563EB; --accent: #F59E0B; --bg: #F0F9FF; --card: #FFFFFF; --success: #10B981; --error: #EF4444; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        
        .container { background-color: var(--card); width: 100%; max-width: 600px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 25px; text-align: center; display: flex; flex-direction: column; position: relative; margin-top: safe-area-inset-top; margin-bottom: safe-area-inset-bottom; }
        
        h1 { color: #333; margin: 0 0 10px 0; font-size: 1.8rem; }
        p { color: #666; margin-bottom: 20px; }
        
        textarea { width: 100%; height: 120px; border: 2px solid #E5E7EB; border-radius: 12px; padding: 15px; font-size: 1.1rem; margin-bottom: 10px; font-family: inherit; resize: none; -webkit-appearance: none; }
        
        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        select { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid var(--primary); border-radius: 12px; font-size: 1rem; color: #333; background-color: #EEF2FF; cursor: pointer; font-weight: bold; -webkit-appearance: none; text-align-last: center; }

        /* èªè¨€åˆ‡æ›åˆ— */
        .lang-switch-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .lang-select { flex: 1; border-color: #F59E0B; background-color: #FFFBEB; }

        .btn { border: none; padding: 12px 20px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: bold; margin: 5px; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background-color: var(--primary); color: white; width: 100%; font-size: 1.1rem; padding: 14px; }
        .btn-outline { background-color: white; border: 2px solid #ddd; color: #555; }
        .btn-home { background-color: #F3F4F6; color: #555; padding: 8px 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; border-radius: 20px; }

        .player-controls { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px; margin-top: 10px; }
        .btn-nav { background-color: #F3F4F6; color: #333; width: 55px; height: 55px; border-radius: 50%; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; }
        .btn-play { background-color: var(--accent); color: white; width: 90px; height: 90px; border-radius: 50%; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4); }
        
        #practice-screen { display: none; }
        .card-display { background: #EEF2FF; border-radius: 16px; padding: 40px 20px; margin-bottom: 25px; min-height: 120px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; border: 2px dashed #A5B4FC; }
        .hidden-text { font-size: 2rem; font-weight: bold; color: #333; filter: blur(15px); transition: filter 0.3s; user-select: none; line-height: 1.4; }
        .revealed { filter: blur(0); }
        
        #result-screen { display: none; }
        .grading-list { text-align: left; margin-top: 10px; max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .grading-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; gap: 10px; }
        .grading-text { flex: 1; font-size: 1.1rem; color: #333; }
        .grading-actions { display: flex; gap: 8px; }
        .grade-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid #E5E7EB; background: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .grade-btn.selected.correct { background-color: var(--success); color: white; border-color: var(--success); transform: scale(1.1); }
        .grade-btn.selected.wrong { background-color: var(--error); color: white; border-color: var(--error); transform: scale(1.1); }

        .login-header { display: flex; justify-content: flex-end; margin-bottom: 15px; align-items: center; }
        .user-name { margin-right: 10px; color: #555; font-size: 0.9rem; font-weight: bold; }
        
        .punc-switch { margin: 10px 0 20px 0; display: flex; align-items: center; justify-content: flex-start; gap: 10px; font-size: 0.95rem; color: #444; background: #F9FAFB; padding: 12px; border-radius: 10px; }
        .punc-switch input { width: 20px; height: 20px; }

        .section-title { text-align: left; font-size: 1rem; font-weight: bold; color: #444; margin: 25px 0 10px 0; border-left: 4px solid var(--primary); padding-left: 10px; }
        .history-list { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; }
        .history-item { background: #F9FAFB; padding: 12px; border-radius: 10px; border: 1px solid #E5E7EB; text-align: left; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .library-container { margin-top: 30px; background: #FFF5F5; padding: 15px; border-radius: 12px; border: 1px solid #FED7D7; }
        .library-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        .library-tag { background: white; color: #C53030; border: 1px solid #FEB2B2; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .delete-btn { width: 20px; height: 20px; background: #E5E7EB; color: #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; }
        .empty-hint { color: #999; font-size: 0.8rem; font-style: italic; }

        /* è´ŠåŠ©å½ˆçª— (FPSç‰ˆ) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-icon { font-size: 4rem; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="login-header">
        <span id="user-info" class="user-name" style="display:none;"></span>
        <button id="login-btn" class="btn" style="background-color: #4285F4; color: white; padding: 8px 15px; font-size: 0.9rem;" onclick="toggleLogin()">Gmailç™»å…¥åŒæ­¥</button>
    </div>

    <div id="setup-screen">
        <h1>é»˜æ›¸å°åŠ©æ‰‹ ğŸ’¯</h1>
        
        <div class="lang-switch-row">
            <select id="lang-select" class="lang-select" onchange="saveLangSetting()">
                <option value="zh-HK">ğŸ—£ï¸ å»£æ±è©± (Cantonese)ğŸ’¡æŒ‰åˆ‡æ›</option>
                <option value="en-GB">ğŸ—£ï¸ è‹±èª (English)ğŸ’¡æŒ‰åˆ‡æ›</option>
            </select>
        </div>

        <select id="preset-select" class="preset-select" onchange="loadPreset()">
            <option value="">ğŸ“‚ é¸æ“‡é è¨­æ•™æ...</option>
            <optgroup label="ä¸­æ–‡ç§‘">
                <option value="idiom1">å°å››æˆèª (ä¸€)</option>
                <option value="hard_words">å¸¸è¦‹æ˜“éŒ¯å­—</option>
                <option value="poem1">å”è©©ï¼šéœå¤œæ€</option>
            </optgroup>
            <optgroup label="English Dictation">
                <option value="eng_vocab">P4 Common Vocabulary</option>
                <option value="eng_sent">Useful Sentences</option>
            </optgroup>
        </select>

        <textarea id="input-text" placeholder="è¼¸å…¥å…§å®¹... (æ”¯æ´ä¸­è‹±æ–‡)
ä¸€ç‰‡å…©ç‰‡ä¸‰å››ç‰‡
äº”å…­ä¸ƒå…«ä¹åç‰‡
åƒç‰‡è¬ç‰‡ç„¡æ•¸ç‰‡
é£›å…¥æ¢…èŠ±éƒ½ä¸è¦‹"></textarea>
        
        <div style="text-align: left; margin-bottom: 5px;">
            <label for="speed">æœ—è®€é€Ÿåº¦ï¼š</label>
            <input type="range" id="speed" min="0.5" max="1.2" step="0.1" value="0.8">
        </div>

        <div class="punc-switch">
            <input type="checkbox" id="punc-toggle" checked>
            <label for="punc-toggle">æœ—è®€æ¨™é» (é€—è™Ÿ/Comma)</label>
        </div>

        <button id="start-btn" class="btn btn-primary" onclick="startDictation()">é–‹å§‹é»˜æ›¸ ğŸš€</button>

        <div id="history-section" style="display:none;">
            <div class="section-title">ğŸ•’ æœ€è¿‘è¨˜éŒ„</div>
            <div id="history-list" class="history-list"></div>
        </div>

        <div id="library-section" class="library-container" style="display:none;">
            <h3 style="margin:0; color:#C53030; font-size:1.1rem;">ğŸ“• éŒ¯é¡Œç©ç´¯åº«</h3>
            <p style="font-size:0.8rem; color:#E53E3E; margin:5px 0;">ç™»å…¥å¾Œè‡ªå‹•æ”¶é›†éŒ¯é¡Œ</p>
            <div id="library-list" class="library-list"></div>
        </div>
    </div>

    <div id="practice-screen">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button class="btn btn-home" onclick="goHome()">ğŸ  ä¿®æ”¹</button>
            <div style="color: #666; font-size: 0.9rem;">é€²åº¦ï¼š<span id="current-count">1</span> / <span id="total-count">4</span></div>
        </div>

        <div class="player-controls">
            <button class="btn-nav" onclick="prevSegment()" id="prev-btn">â®ï¸</button>
            <button class="btn-play" onclick="speakCurrent()">ğŸ”Š</button>
            <button class="btn-nav" onclick="nextSegment()" id="next-btn">â­ï¸</button>
        </div>

        <div class="card-display" onclick="toggleReveal()">
            <span style="font-size:0.8rem; color:#888; margin-bottom:10px;">(é»æ“Šå·çœ‹ï¼Œæˆ–æŒ‰ä¸‹ä¸€æ®µ)</span>
            <div id="word-display" class="hidden-text">...</div>
        </div>

        <button class="btn btn-primary" id="finish-btn" onclick="finishDictation()" style="display:none; background-color: #10B981;">å®Œæˆï¼Œå»æ‰¹æ”¹ ğŸ“</button>
    </div>

    <div id="result-screen">
        <h2>ğŸ“ å®¶é•·æ‰¹æ”¹å€</h2>
        <div id="grading-list" class="grading-list"></div>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3 id="score-text" style="color: var(--primary);">100åˆ†</h3>
            <button class="btn btn-primary" onclick="retryWrong()" id="retry-btn" style="display:none;">åªé‡é»˜éŒ¯é¡Œ â†»</button>
            <button class="btn btn-outline" onclick="goHome()" style="width:100%">å›é¦–é </button>
        </div>
    </div>
<div style="margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 0.8rem; color: #888;">
    <p>è©¦ç”¨ç‰ˆæœ¬ v1.0 | <a href="https://forms.gle/https://docs.google.com/forms/d/e/1FAIpQLScgbfDioA7kNQHkHKuJdg7WGaI4ExPmQ4bqwfR6e4WT6nBrNQ/viewform?usp=publish-editor" target="_blank" style="color: #2563EB;">ğŸ“ è«‹å¡«google form å‚³é”æ„è¦‹å›é¥‹ </a></p>
</div>
</div>

<div id="coffee-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-icon">â˜•</div>
        <h2>è¦ºå¾—å¥½ç”¨å—ï¼Ÿ</h2>
        <p>æ‚¨å·²ç¶“å®Œæˆäº† <span id="usage-count" style="font-weight:bold; color:blue;">100</span> æ¬¡é»˜æ›¸ï¼<br>
        æ”¯æŒç¶²ç«™ç‡Ÿé‹ï¼Œæ­¡è¿ç”¨ <strong>FPS è½‰æ•¸å¿«</strong><br>
        éš¨ç·£è´ŠåŠ©ï¼Œå¤šè¬æ”¯æŒ</p>
        
        <div style="margin: 15px 0; background: #F3F4F6; padding: 15px; border-radius: 10px;">
            <p style="margin: 0 0 5px 0; color: #555; font-size: 0.9rem;">FPS è­˜åˆ¥ç¢¼ï¼š</p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span id="fps-id" style="font-size: 1.5rem; font-weight: bold; color: #333;">9390790</span>
                <button onclick="copyFPS()" style="background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer;">è¤‡è£½</button>
            </div>
            <p style="font-size: 0.7rem; color: #999; margin-top:5px;">(è¤‡è£½å¾Œè«‹æ‰“é–‹éŠ€è¡ŒAppä»˜æ¬¾)</p>
        </div>

        <button class="btn btn-outline" onclick="closeModal()" style="width:100%; border:none; color:#999;">ä¸‹æ¬¡å†èªª</button>
    </div>
</div>


<script type="module">
    // -----------------------------------------------------------
    // âš ï¸ è«‹æ›ä¸Šæ‚¨çš„ Firebase Config âš ï¸
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCanvj4YN4pK9rqrwDBNQxh8moEpCKnE_s",
        authDomain: "dictationhelper-404f8.firebaseapp.com",
        projectId: "dictationhelper-404f8",
        storageBucket: "dictationhelper-404f8.firebasestorage.app",
        messagingSenderId: "177896505968",
        appId: "1:177896505968:web:a147e5648204f472986ab5"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let segments = [];
    let currentIndex = 0;
    let gradingResults = [];
    let currentUser = null;
    let historyData = [];
    let libraryData = [];

    // é è¨­æ•™æ
    const presetData = {
        "idiom1": "ä¸€å¿ƒä¸€æ„, äº”é¡å…­è‰², ä¸ƒä¸Šå…«ä¸‹, ä¹ç‰›ä¸€æ¯›\nåƒæ–¹ç™¾è¨ˆ, ç•«è›‡æ·»è¶³, å®ˆæ ªå¾…å…”, äº•åº•ä¹‹è›™",
        "hard_words": "å·²ç¶“, æ›¾ç¶“, å³ä½¿, æ—¢ç„¶\nè¾¨åˆ¥, è¾¯è«–, è¾®å­, èŠ±ç“£\nå»ºè­°, å»ºè¨­, å¥åº·, é—œéµ",
        "poem1": "åºŠå‰æ˜æœˆå…‰\nç–‘æ˜¯åœ°ä¸Šéœœ\nèˆ‰é ­æœ›æ˜æœˆ\nä½é ­æ€æ•…é„‰",
        "eng_vocab": "beautiful, dangerous, exciting, famous\nfriendly, important, interesting, popular",
        "eng_sent": "What time is it?\nIt is half past two.\nWhere are you going?\nI am going to the library."
    };
    window.loadPreset = function() {
        const key = document.getElementById('preset-select').value;
        if (key && presetData[key]) {
            document.getElementById('input-text').value = presetData[key];
            // è‡ªå‹•åˆ‡æ›èªè¨€
            if (key.startsWith('eng')) {
                document.getElementById('lang-select').value = 'en-GB';
            } else {
                document.getElementById('lang-select').value = 'zh-HK';
            }
        }
    }

    // èº«ä»½èˆ‡è³‡æ–™
    window.toggleLogin = function() {
        if (auth.currentUser) signOut(auth).then(()=>alert("å·²ç™»å‡º"));
        else signInWithPopup(auth, provider).catch(e=>alert(e.message));
    };

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const loginBtn = document.getElementById('login-btn');
        const userInfo = document.getElementById('user-info');
        if (user) {
            loginBtn.textContent = "ç™»å‡º";
            userInfo.style.display = "block";
            userInfo.textContent = `Hi, ${user.displayName}`;
            loadUserData(user);
        } else {
            loginBtn.textContent = "Gmailç™»å…¥åŒæ­¥";
            userInfo.style.display = "none";
            document.getElementById('history-section').style.display = 'none';
            document.getElementById('library-section').style.display = 'none';
        }
    });

    async function loadUserData(user) {
        try {
            const docSnap = await getDoc(doc(db, "users", user.uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.history) historyData = data.history;
                if (data.wrongLibrary) libraryData = data.wrongLibrary;
                renderHistory();
                renderLibrary();
            }
        } catch (e) { console.error(e); }
    }

    async function saveDataToCloud(isNewDictation = false) {
        if (!currentUser) return;
        try {
            const userRef = doc(db, "users", currentUser.uid);
            let updatePayload = {
                history: historyData,
                wrongLibrary: libraryData,
                lastUpdated: new Date()
            };
            if (isNewDictation) updatePayload.dictationCount = increment(1);

            await setDoc(userRef, updatePayload, { merge: true });

            if (isNewDictation) checkUsageAndPrompt();

        } catch (e) { console.error("åŒæ­¥å¤±æ•—", e); }
    }

    async function checkUsageAndPrompt() {
        if (!currentUser) return;
        const docSnap = await getDoc(doc(db, "users", currentUser.uid));
        if (docSnap.exists()) {
            const count = docSnap.data().dictationCount || 0;
            if (count > 0 && (count === 5 || (count > 5 && (count - 5) % 10 === 0))) {
                showCoffeeModal(count);
            }
        }
    }

    // --- æ ¸å¿ƒæµç¨‹ ---
    window.saveLangSetting = function() {
        localStorage.setItem('dictationLang', document.getElementById('lang-select').value);
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        const section = document.getElementById('history-section');
        if (historyData.length > 0) {
            section.style.display = 'block';
            list.innerHTML = '';
            historyData.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                const preview = text.replace(/\n/g, " ").substring(0, 20) + (text.length>20 ? "..." : "");
                item.innerHTML = `<div style="flex:1" onclick="loadHistoryItem(${index})">${preview}</div><div class="delete-btn" onclick="deleteHistory(${index})">âœ•</div>`;
                list.appendChild(item);
            });
        } else { section.style.display = 'none'; }
    }
    window.loadHistoryItem = function(index) { document.getElementById('input-text').value = historyData[index]; }
    window.deleteHistory = function(index) { historyData.splice(index, 1); renderHistory(); saveDataToCloud(); }

    function renderLibrary() {
        const list = document.getElementById('library-list');
        const section = document.getElementById('library-section');
        section.style.display = 'block';
        if (libraryData.length > 0) {
            list.innerHTML = '';
            libraryData.forEach((text, index) => {
                const tag = document.createElement('div');
                tag.className = 'library-tag';
                tag.innerHTML = `<span onclick="appendFromLibrary(${index})">${text}</span><div class="delete-btn" onclick="deleteLibrary(${index})">âœ•</div>`;
                list.appendChild(tag);
            });
        } else { list.innerHTML = '<div class="empty-hint">ç™»å…¥å¾Œå°‡è‡ªå‹•æ”¶é›†éŒ¯é¡Œ</div>'; }
    }
    window.appendFromLibrary = function(index) {
        const input = document.getElementById('input-text');
        input.value = (input.value.trim() !== "") ? input.value + "\n" + libraryData[index] : libraryData[index];
        input.focus();
    }
    window.deleteLibrary = function(index) {
        if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { libraryData.splice(index, 1); renderLibrary(); saveDataToCloud(); }
    }

    window.goHome = function() {
        window.speechSynthesis.cancel();
        document.getElementById('practice-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'block';
    }

    window.startDictation = function() {
        const input = document.getElementById('input-text').value;
        localStorage.setItem('dictationInput', input);
        localStorage.setItem('puncToggle', document.getElementById('punc-toggle').checked);
        localStorage.setItem('dictationLang', document.getElementById('lang-select').value);
        
        if (!input.trim()) { alert("è«‹è¼¸å…¥å…§å®¹"); return; }

        let isNew = false;
        if (historyData.length === 0 || historyData[0] !== input) {
            historyData.unshift(input);
            if (historyData.length > 5) historyData.pop();
            renderHistory();
            isNew = true;
        }
        saveDataToCloud(isNew);

        segments = input.split(/[\n]+/).filter(w => w.trim() !== "");
        if (segments.length === 1) segments = input.split(/[,ï¼Œ\n]+/).filter(w => w.trim() !== "");
        if (segments.length === 0) return;

        currentIndex = 0; gradingResults = new Array(segments.length).fill(null); 
        showPracticeScreen(); loadSegment();
    }

    window.retryWrong = function() {
        const wrongOnes = segments.filter((_, i) => gradingResults[i] === false);
        if (wrongOnes.length === 0) return;
        segments = wrongOnes;
        currentIndex = 0;
        gradingResults = new Array(segments.length).fill(null);
        showPracticeScreen();
        loadSegment();
    }

    function showPracticeScreen() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('practice-screen').style.display = 'block';
        document.getElementById('total-count').textContent = segments.length;
    }

    function loadSegment() {
        document.getElementById('current-count').textContent = currentIndex + 1;
        const w = document.getElementById('word-display');
        w.textContent = segments[currentIndex];
        w.classList.remove('revealed');
        document.getElementById('prev-btn').disabled = (currentIndex === 0);
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        if (currentIndex === segments.length - 1) { nextBtn.style.display = 'none'; finishBtn.style.display = 'block'; }
        else { nextBtn.style.display = 'flex'; finishBtn.style.display = 'none'; }
        setTimeout(window.speakCurrent, 500);
    }

    window.prevSegment = function() { if (currentIndex > 0) { currentIndex--; loadSegment(); } }
    window.nextSegment = function() { if (currentIndex < segments.length - 1) { currentIndex++; loadSegment(); } }

    // *** é›™èªç™¼éŸ³æ ¸å¿ƒ logic ***
    window.speakCurrent = function() {
        window.speechSynthesis.cancel();
        
        let textToSpeak = segments[currentIndex];
        const lang = document.getElementById('lang-select').value; // å–å¾—ç›®å‰èªè¨€
        const shouldReadPunc = document.getElementById('punc-toggle').checked;
        
        if (shouldReadPunc) {
            if (lang === 'zh-HK') {
                // ä¸­æ–‡æ¨™é»
                textToSpeak = textToSpeak
                    .replace(/ï¼Œ/g, "ï¼Œé€—è™Ÿï¼Œ").replace(/ã€‚/g, "ã€‚å¥è™Ÿã€‚").replace(/ï¼Ÿ/g, "ï¼Ÿå•è™Ÿï¼Ÿ")
                    .replace(/ï¼/g, "ï¼æ„Ÿå˜†è™Ÿï¼").replace(/ã€/g, "ã€é “è™Ÿã€").replace(/ï¼š/g, "ï¼šå†’è™Ÿï¼š")
                    .replace(/ï¼›/g, "ï¼›åˆ†è™Ÿï¼›").replace(/[ã€Œâ€œ]/g, "é–‹å¼•è™Ÿ").replace(/[ã€â€]/g, "é—œå¼•è™Ÿ");
            } else {
                // è‹±æ–‡æ¨™é»
                textToSpeak = textToSpeak
                    .replace(/,/g, " comma ")
                    .replace(/\./g, " full stop ")
                    .replace(/\?/g, " question mark ")
                    .replace(/!/g, " exclamation mark ")
                    .replace(/-/g, " hyphen ")
                    .replace(/:/g, " colon ")
                    .replace(/;/g, " semicolon ")
                    .replace(/["â€œ]/g, " open quote ")
                    .replace(/["â€]/g, " close quote ");
            }
        }

        const u = new SpeechSynthesisUtterance(textToSpeak);
        u.lang = lang; // å‹•æ…‹è¨­å®šèªè¨€ (en-GB æˆ– zh-HK)
        u.rate = document.getElementById('speed').value;
        window.speechSynthesis.speak(u);
    }

    window.toggleReveal = function() { document.getElementById('word-display').classList.toggle('revealed'); }

    window.finishDictation = function() {
        document.getElementById('practice-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        renderGradingList();
    }

    function renderGradingList() {
        const listDiv = document.getElementById('grading-list');
        listDiv.innerHTML = '';
        segments.forEach((seg, index) => {
            const item = document.createElement('div');
            item.className = 'grading-item';
            const isCorrect = gradingResults[index] === true;
            const isWrong = gradingResults[index] === false;
            item.innerHTML = `<div class="grading-text">${index + 1}. ${seg}</div><div class="grading-actions"><button onclick="setGrade(${index}, true)" class="grade-btn ${isCorrect ? 'selected correct' : ''}">âœ…</button><button onclick="setGrade(${index}, false)" class="grade-btn ${isWrong ? 'selected wrong' : ''}">âŒ</button></div>`;
            listDiv.appendChild(item);
        });
        updateScore();
    }

    window.setGrade = function(index, isCorrect) {
        if (gradingResults[index] === isCorrect) gradingResults[index] = null;
        else gradingResults[index] = isCorrect;
        
        if (gradingResults[index] === false) {
            const wrongText = segments[index];
            if (!libraryData.includes(wrongText)) {
                libraryData.push(wrongText);
                renderLibrary();
                saveDataToCloud();
            }
        }
        renderGradingList(); 
    }

    function updateScore() {
        const total = segments.length;
        const correctCount = gradingResults.filter(r => r === true).length;
        const wrongCount = gradingResults.filter(r => r === false).length;
        document.getElementById('score-text').textContent = `ç­”å°ï¼š${correctCount} / ${total}`;
        document.getElementById('retry-btn').style.display = wrongCount > 0 ? 'inline-block' : 'none';
    }

    window.closeModal = function() { document.getElementById('coffee-modal').style.display = 'none'; }
    window.showCoffeeModal = function(count) {
        document.getElementById('usage-count').textContent = count;
        document.getElementById('coffee-modal').style.display = 'flex';
    }
    window.copyFPS = function() {
        const fpsId = document.getElementById('fps-id').innerText;
        navigator.clipboard.writeText(fpsId).then(() => { alert("å·²è¤‡è£½ï¼"); });
    }

    const savedInput = localStorage.getItem('dictationInput');
    if (savedInput) document.getElementById('input-text').value = savedInput;
    const savedPunc = localStorage.getItem('puncToggle');
    if (savedPunc !== null) document.getElementById('punc-toggle').checked = (savedPunc === 'true');
    const savedLang = localStorage.getItem('dictationLang');
    if (savedLang) document.getElementById('lang-select').value = savedLang;



</script>
</body>
</html>